# Документация по работе с лабораторной работой №1

## Описание системы

Лабораторная работа №1 предоставляет API для генерации отчета о 10 студентах с наименьшим процентом посещения лекций, содержащих заданный термин или фразу, за указанный период обучения. Система использует следующие компоненты:
- **API Gateway**: Обрабатывает аутентификацию и перенаправляет запросы к сервису `lab1`.
- **Сервис lab1**: Обрабатывает запросы к эндпоинту `/api/lab1/report`, извлекая данные из баз данных.
- **PostgreSQL**: Хранит данные о студентах, группах, расписании, занятиях и посещаемости.
- **Elasticsearch**: Хранит материалы лекций для поиска по термину.
- **Neo4j**: Хранит данные о расписании и связях между лекциями и группами.
- **Redis**: Используется для кэширования информации о студентах по группам.

Отчет включает полную информацию о студенте (ID, ФИО, ID группы, номер зачетной книжки), процент посещаемости, период отчета и термин, использованный для поиска.

## Подготовка к работе

Перед началом работы убедитесь, что система настроена и запущена:

1. **Запуск контейнеров**:
   Выполните команду для запуска всех сервисов:
   ```bash
   docker compose up -d
   ```
   Это запустит контейнеры для `gateway`, `lab1`, `postgres`, `mongo`, `neo4j`, `elasticsearch` и `redis`.

2. **Проверка данных в базах**:
   Убедитесь, что данные присутствуют и синхронизированы:
   - **PostgreSQL**: Таблицы `students`, `student_groups`, `schedule`, `class`, `class_materials`, `attendance`.
   - **Elasticsearch**: Индекс `class_materials` с материалами лекций.
   - **Neo4j**: Узлы `Schedule`, `Class`, `StudentGroup` и связи `HAS_SCHEDULE`, `FOR_CLASS`.
   - **Redis**: Кэш с данными студентов в формате `student:<id>` и индексы `index:student:group_id:<id>`.

   Для проверки данных в PostgreSQL можно выполнить:
   ```bash
   docker exec -it postgres psql -U postgres_user -d postgres_db -c "\dt"
   ```
   Для Neo4j:
   ```bash
   docker exec -it neo4j cypher-shell -u neo4j -p strongpassword -q "MATCH (n) RETURN n LIMIT 5;"
   ```

## Получение токена аутентификации

Для доступа к API необходим JWT-токен:

1. Выполните POST-запрос к эндпоинту `/api/token`:
   ```bash
   curl -X POST http://gateway:3001/api/token -H "Content-Type: application/json" -d '{"username":"vlad","password":"supersecret"}'
   ```
   Ответ будет содержать токен, например:
   ```json
   {"access_token": "<ваш_токен>"}
   ```

2. Сохраните токен в переменную окружения:
   ```bash
   export TOKEN=<ваш_токен>
   ```

## Выполнение запроса к API

Для получения отчета отправьте POST-запрос к эндпоинту `/api/lab1/report`:

1. **Пример запроса**:
   ```bash
   curl -X POST http://gateway:3001/api/lab1/report -H "Content-Type: application/json" -H "Authorization: Bearer $TOKEN" -d '{"material":"кинематика","start_date":"2023-09-01","end_date":"2023-12-31"}'
   ```
   - **Параметры**:
     - `material`: Строка для поиска в материалах лекций (например, "кинематика").
     - `start_date`: Начальная дата периода в формате `YYYY-MM-DD`.
     - `end_date`: Конечная дата периода в формате `YYYY-MM-DD`.

2. **Формат ответа**:
   Ожидаемый ответ — JSON-объект со следующей структурой:
   ```json
   {
     "report": {
       "search_term": "кинематика",
       "period": "2023-09-01 - 2023-12-31",
       "worst_attendees": [
         {
           "student_id": 1,
           "name": "Иванов Иван",
           "group_id": 1,
           "book_number": "01001",
           "missed_lectures": 5,
           "total_lectures": 10,
           "attendance_percent": 50.0
         },
         // ... до 10 студентов
       ]
     }
   }
   ```
   - `search_term`: Термин, использованный для поиска.
   - `period`: Период отчета в формате "start_date - end_date".
   - `worst_attendees`: Массив из до 10 студентов с наименьшим процентом посещаемости, каждый из которых включает:
     - `student_id`: ID студента.
     - `name`: ФИО студента.
     - `group_id`: ID группы студента.
     - `book_number`: Номер зачетной книжки.
     - `missed_lectures`: Количество пропущенных лекций.
     - `total_lectures`: Общее количество лекций.
     - `attendance_percent`: Процент посещаемости (в процентах).

## Логирование и отладка

Если возникают ошибки при выполнении запроса:

1. **Проверка логов**:
   Просмотрите логи сервиса `lab1` для диагностики:
   ```bash
   docker logs lab1
   ```
   Логи содержат информацию о подключении к базам данных, выполнении запросов и возможных ошибках.

2. **Проверка данных**:
   Убедитесь, что данные в базах данных соответствуют запросу:
   - В Elasticsearch проверьте наличие материалов с термином:
     ```bash
     curl -X GET "http://elasticsearch:9200/class_materials/_search" -H "Content-Type: application/json" -d '{"query": {"match": {"content": "кинематика"}}}'
     ```
   - В Neo4j проверьте расписание лекций:
     ```bash
     docker exec -it neo4j cypher-shell -u neo4j -p strongpassword -q "MATCH (g:StudentGroup)-[:HAS_SCHEDULE]->(sch:Schedule)-[:FOR_CLASS]->(c:Class) WHERE c.type = 'лекция' RETURN sch.postgres_id, c.postgres_id, sch.scheduled_date LIMIT 5;"
     ```
   - В PostgreSQL проверьте данные о посещаемости:
     ```bash
     docker exec -it postgres psql -U postgres_user -d postgres_db -c "SELECT * FROM attendance LIMIT 5;"
     ```

3. **Типичные проблемы**:
   - Отсутствие данных в одной из баз (например, пустой индекс в Elasticsearch).
   - Некорректный формат дат в запросе (должен быть `YYYY-MM-DD`).
   - Проблемы с подключением к базам данных (проверьте переменные окружения в `env.py`).

## Обновление данных

Для корректной работы API данные в базах должны быть актуальными:

1. **Elasticsearch**: Убедитесь, что индекс `class_materials` содержит актуальные материалы лекций. Для синхронизации выполните:
   ```bash
   python db_utils/elastic/sync_elastic_tables.py
   ```

2. **Neo4j**: Синхронизируйте данные расписания и связей:
   ```bash
   python db_utils/neo4j/sync_neo4j_tables.py
   ```

3. **Redis**: Данные о студентах кэшируются автоматически при запросе. Для принудительной синхронизации:
   ```bash
   python db_utils/redis/sync_redis_tables.py
   ```

4. **PostgreSQL**: Убедитесь, что таблицы заполнены. Для заполнения тестовыми данными:
   ```bash
   python db_utils/postgres/generate_postgres_data.py
   ```

## Остановка системы

Для завершения работы остановите все контейнеры:
```bash
docker compose down
```

## Таблица зависимостей сервисов

| Сервис         | Роль в лабораторной работе №1                     | Зависимости                     |
|----------------|--------------------------------------------------|---------------------------------|
| API Gateway    | Аутентификация и маршрутизация запросов          | lab1                            |
| lab1           | Обработка запросов и генерация отчета            | PostgreSQL, Elasticsearch, Neo4j, Redis |
| PostgreSQL     | Хранение данных о студентах и посещаемости       | -                               |
| Elasticsearch  | Поиск материалов лекций по термину               | -                               |
| Neo4j          | Хранение расписания и связей                    | -                               |
| Redis          | Кэширование информации о студентах              | -                               |

## Примечания

- Убедитесь, что переменные окружения в `env.py` соответствуют настройкам в `docker-compose.yml`.
- Если данные в базах отсутствуют, отчет может быть пустым (поле `worst_attendees` будет пустым массивом).
- Для работы с API используйте корректный формат дат (`YYYY-MM-DD`) и убедитесь, что термин поиска соответствует содержимому материалов лекций.